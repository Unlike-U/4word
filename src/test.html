<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4Word Crypto Tests</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #0a0a0a;
            color: #00ff88;
            padding: 20px;
            max-width: 1000px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            border-bottom: 2px solid #00ff88;
            padding-bottom: 10px;
        }
        
        .test-section {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        button {
            background: linear-gradient(135deg, #00ff88, #00cc6a);
            color: #000;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        button:hover {
            box-shadow: 0 4px 12px rgba(0, 255, 136, 0.4);
            transform: translateY(-2px);
        }

        button:active {
            transform: translateY(0);
        }
        
        #output {
            background: #000;
            border: 1px solid #2a2a2a;
            border-radius: 4px;
            padding: 15px;
            margin-top: 20px;
            font-size: 12px;
            line-height: 1.6;
            max-height: 500px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
        }
        
        .success { color: #00ff88; }
        .error { color: #ff0088; }
        .warning { color: #ffaa00; }
        .info { color: #0088ff; }

        .loading {
            opacity: 0.6;
        }
    </style>
</head>
<body>
    <h1>üîê 4Word Crypto Test Suite</h1>
    
    <div class="test-section">
        <h2>Quick Tests</h2>
        <button id="btnCrypto">Test Web Crypto API</button>
        <button id="btnStego">Test Steganography</button>
        <button id="btnStorage">Test IndexedDB</button>
        <button id="btnValidation">Test Validation</button>
        <button id="btnAll">Run All Tests</button>
        <button id="btnClear">Clear Output</button>
    </div>
    
    <div id="output"></div>
    
    <script type="module">
        // Import modules
        import crypto from './js/crypto/webCrypto.js';
        import stego from './js/crypto/steganography.js';
        import storage from './js/storage/indexedDB.js';
        import { Validator } from './js/utils/validation.js';
        
        const output = document.getElementById('output');
        
        function log(message, type = 'info') {
            const line = document.createElement('div');
            line.className = type;
            line.textContent = message;
            output.appendChild(line);
            output.scrollTop = output.scrollHeight;
        }
        
        function clearOutput() {
            output.innerHTML = '';
        }
        
        async function testCrypto() {
            log('‚ïê'.repeat(50), 'info');
            log('üß™ Testing Web Crypto API...', 'info');
            log('‚ïê'.repeat(50), 'info');
            
            try {
                // Test 1: Basic encryption
                log('\n1Ô∏è‚É£ Testing basic encryption...', 'info');
                const message = 'Hello 4Word Test!';
                const password = 'TestPassword123!';
                
                const encrypted = await crypto.encrypt(message, password);
                log(`‚úÖ Encrypted (${encrypted.encrypted.length} chars)`, 'success');
                log(`   Algorithm: ${encrypted.algorithm}`, 'info');
                log(`   Iterations: ${encrypted.iterations}`, 'info');
                
                const decrypted = await crypto.decrypt(encrypted, password);
                log(`‚úÖ Decrypted: "${decrypted}"`, 'success');
                
                if (decrypted === message) {
                    log('‚úÖ Encryption/Decryption verified!', 'success');
                } else {
                    throw new Error('Decryption mismatch!');
                }
                
                // Test 2: Double encryption
                log('\n2Ô∏è‚É£ Testing double encryption (2DE)...', 'info');
                const doubleEnc = await crypto.doubleEncrypt(message, 'pass1', 'pass2');
                log(`‚úÖ 2DE encrypted (${doubleEnc.layers} layers)`, 'success');
                log(`   Algorithm: ${doubleEnc.algorithm}`, 'info');
                
                const doubleDec = await crypto.doubleDecrypt(doubleEnc, 'pass1', 'pass2');
                log(`‚úÖ 2DE decrypted: "${doubleDec}"`, 'success');
                
                if (doubleDec === message) {
                    log('‚úÖ 2DE verified!', 'success');
                } else {
                    throw new Error('2DE decryption mismatch!');
                }
                
                // Test 3: Password generation
                log('\n3Ô∏è‚É£ Testing password generation...', 'info');
                const genPass = crypto.generateSecurePassword(32);
                log(`‚úÖ Generated: ${genPass}`, 'success');
                log(`   Length: ${genPass.length}`, 'info');
                
                // Test 4: Hash
                log('\n4Ô∏è‚É£ Testing hash function...', 'info');
                const hash1 = await crypto.hash('test data');
                const hash2 = await crypto.hash('test data');
                const hash3 = await crypto.hash('different data');
                
                log(`‚úÖ Hash 1: ${hash1.substring(0, 30)}...`, 'success');
                log(`‚úÖ Deterministic: ${hash1 === hash2}`, 'success');
                log(`‚úÖ Different input = different hash: ${hash1 !== hash3}`, 'success');
                
                log('\nüéâ All crypto tests passed!', 'success');
                
            } catch (error) {
                log(`‚ùå Test failed: ${error.message}`, 'error');
                console.error(error);
            }
        }
        
        function testStego() {
            log('‚ïê'.repeat(50), 'info');
            log('üñºÔ∏è Testing Steganography...', 'info');
            log('‚ïê'.repeat(50), 'info');
            log('\n‚úÖ Steganography module loaded', 'success');
            log('   Available methods:', 'info');
            log('   - embedMessage(imageFile, message, password)', 'info');
            log('   - extractMessage(imageFile, password)', 'info');
            log('   - getImageCapacity(imageFile)', 'info');
            log('\n‚ö†Ô∏è Full testing requires image file upload', 'warning');
            log('   Use the main app to test stego features', 'info');
        }
        
        async function testStorage() {
            log('‚ïê'.repeat(50), 'info');
            log('üíæ Testing IndexedDB Storage...', 'info');
            log('‚ïê'.repeat(50), 'info');
            
            try {
                log('\n1Ô∏è‚É£ Initializing storage...', 'info');
                await storage.init();
                log('‚úÖ Storage initialized', 'success');
                
                log('\n2Ô∏è‚É£ Getting statistics...', 'info');
                const stats = await storage.getStats();
                log(`‚úÖ Messages in DB: ${stats.messageCount}`, 'success');
                log(`   Database: ${stats.dbName} v${stats.version}`, 'info');
                
                log('\n3Ô∏è‚É£ Testing save/retrieve...', 'info');
                const masterPass = 'test-master-pass-' + Date.now();
                const testMessage = {
                    type: 'test',
                    content: 'Test message from test suite',
                    timestamp: Date.now()
                };
                
                const id = await storage.saveMessage(testMessage, masterPass);
                log(`‚úÖ Message saved (ID: ${id})`, 'success');
                
                const messages = await storage.getMessages(masterPass, 5);
                log(`‚úÖ Retrieved ${messages.length} messages`, 'success');
                
                if (messages.length > 0) {
                    log(`   Latest message: "${messages[0].content}"`, 'info');
                }
                
                log('\n4Ô∏è‚É£ Testing delete...', 'info');
                await storage.deleteMessage(id);
                log('‚úÖ Message deleted', 'success');
                
                const afterDelete = await storage.getMessages(masterPass, 5);
                log(`‚úÖ Messages after delete: ${afterDelete.length}`, 'success');
                
                log('\nüéâ Storage tests passed!', 'success');
                
            } catch (error) {
                log(`‚ùå Test failed: ${error.message}`, 'error');
                console.error(error);
            }
        }
        
        function testValidation() {
            log('‚ïê'.repeat(50), 'info');
            log('üõ°Ô∏è Testing Validation...', 'info');
            log('‚ïê'.repeat(50), 'info');
            
            try {
                // Test 1: Address validation
                log('\n1Ô∏è‚É£ Testing address validation...', 'info');
                const validAddr = '0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb0';
                const invalidAddr = '0xinvalid';
                const shortAddr = '0x123';
                
                log(`‚úÖ Valid address check: ${Validator.isValidAddress(validAddr)}`, 
                    Validator.isValidAddress(validAddr) ? 'success' : 'error');
                log(`‚úÖ Invalid address rejected: ${!Validator.isValidAddress(invalidAddr)}`, 
                    !Validator.isValidAddress(invalidAddr) ? 'success' : 'error');
                log(`‚úÖ Short address rejected: ${!Validator.isValidAddress(shortAddr)}`, 
                    !Validator.isValidAddress(shortAddr) ? 'success' : 'error');
                
                // Test 2: Password strength
                log('\n2Ô∏è‚É£ Testing password strength...', 'info');
                const passwords = [
                    'weak',
                    'Better123',
                    'Strong123!@#',
                    'VeryStrong123!@#ABC'
                ];
                
                passwords.forEach(pass => {
                    const result = Validator.validatePasswordStrength(pass);
                    const color = result.strength === 'strong' ? 'success' : 
                                  result.strength === 'medium' ? 'warning' : 'error';
                    log(`   "${pass}": ${result.strength.toUpperCase()}`, color);
                    if (result.errors.length > 0) {
                        result.errors.forEach(err => log(`      - ${err}`, 'warning'));
                    }
                });
                
                // Test 3: String sanitization (avoid script tag issue)
                log('\n3Ô∏è‚É£ Testing string sanitization...', 'info');
                const unsafeString = '<img src=x onerror=alert(1)>';
                const safe = Validator.sanitizeString(unsafeString);
                log(`   Input:  ${unsafeString}`, 'warning');
                log(`   Output: ${safe}`, 'success');
                log('‚úÖ XSS tags sanitized', 'success');
                
                // Test 4: File validation
                log('\n4Ô∏è‚É£ Testing file validation...', 'info');
                log('   validateFileSize() - available', 'success');
                log('   validateImageFile() - available', 'success');
                log('   sanitizeFilename() - available', 'success');
                
                const testFilename = '../../../etc/passwd!@#$%.txt';
                const safeFilename = Validator.sanitizeFilename(testFilename);
                log(`   Unsafe: ${testFilename}`, 'warning');
                log(`   Safe:   ${safeFilename}`, 'success');
                
                log('\nüéâ Validation tests passed!', 'success');
                
            } catch (error) {
                log(`‚ùå Test failed: ${error.message}`, 'error');
                console.error(error);
            }
        }
        
        async function testAll() {
            clearOutput();
            log('üöÄ Running complete test suite...', 'info');
            log('‚ïê'.repeat(50), 'info');
            log('', 'info');
            
            await testCrypto();
            log('\n', 'info');
            
            testStego();
            log('\n', 'info');
            
            await testStorage();
            log('\n', 'info');
            
            testValidation();
            
            log('\n' + '‚ïê'.repeat(50), 'info');
            log('‚úÖ COMPLETE TEST SUITE FINISHED!', 'success');
            log('‚ïê'.repeat(50), 'info');
            log('\nAll modules are working correctly! üéâ', 'success');
        }
        
        // Attach event listeners
        document.getElementById('btnCrypto').addEventListener('click', testCrypto);
        document.getElementById('btnStego').addEventListener('click', testStego);
        document.getElementById('btnStorage').addEventListener('click', testStorage);
        document.getElementById('btnValidation').addEventListener('click', testValidation);
        document.getElementById('btnAll').addEventListener('click', testAll);
        document.getElementById('btnClear').addEventListener('click', clearOutput);
        
        // Auto-run initial check
        log('‚úÖ Test page loaded successfully', 'success');
        log('‚úÖ All modules imported', 'success');
        log('', 'info');
        log('Click a button above to run tests', 'info');
        log('Recommended: Click "Run All Tests" first', 'warning');
        
    </script>
</body>
</html>
