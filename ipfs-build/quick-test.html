<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4Word Quick Test</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body { 
            background: #0a0a0a; 
            color: #00ff88; 
            font-family: 'Courier New', monospace; 
            padding: 20px;
            max-width: 900px;
            margin: 0 auto;
            line-height: 1.6;
        }

        h1 {
            text-align: center;
            border-bottom: 2px solid #00ff88;
            padding-bottom: 16px;
            margin-bottom: 24px;
            font-size: 28px;
        }

        h2 {
            color: #00ff88;
            margin-top: 24px;
            margin-bottom: 12px;
            font-size: 20px;
        }

        pre { 
            background: #000; 
            padding: 20px; 
            border: 1px solid #2a2a2a; 
            border-radius: 8px;
            line-height: 1.8;
            overflow-x: auto;
            font-size: 13px;
        }

        .success { color: #00ff88; }
        .error { color: #ff0088; }
        .warning { color: #ffaa00; }
        .info { color: #0088ff; }

        .security-warning {
            background: #ff008822;
            border: 2px solid #ff0088;
            padding: 24px;
            margin: 24px 0;
            border-radius: 12px;
        }

        .security-warning h2 {
            color: #ff0088;
            margin-top: 0;
            margin-bottom: 16px;
        }

        .security-warning ul {
            margin: 16px 0;
            padding-left: 24px;
        }

        .security-warning li {
            margin: 8px 0;
        }

        .solution {
            background: #00ff8811;
            border-left: 4px solid #00ff88;
            padding: 16px;
            margin: 12px 0;
            border-radius: 4px;
        }

        .solution strong {
            color: #00ff88;
            display: block;
            margin-bottom: 8px;
            font-size: 16px;
        }

        .solution p {
            margin: 8px 0;
            color: #ccc;
        }

        .solution code {
            background: #1a1a1a;
            padding: 4px 8px;
            border-radius: 4px;
            color: #00ff88;
            font-family: 'Courier New', monospace;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 8px;
        }

        .badge-success {
            background: #00ff8822;
            border: 1px solid #00ff88;
            color: #00ff88;
        }

        .badge-error {
            background: #ff008822;
            border: 1px solid #ff0088;
            color: #ff0088;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #00ff8844;
            border-top-color: #00ff88;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        footer {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #2a2a2a;
            text-align: center;
            color: #666;
            font-size: 12px;
        }

        footer a {
            color: #00ff88;
            text-decoration: none;
        }

        footer a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <h1>üîê 4Word Crypto Test Suite</h1>
    
    <div id="security-check"></div>
    <pre id="output" class="loading"><span class="spinner"></span>Running security checks...</pre>
    
    <footer>
        <p>4Word v1.0.0 | <a href="https://github.com/Unlike-U/4word" target="_blank">GitHub</a></p>
        <p>Web3-Powered Secure Messaging - Private, Modular, Eternal</p>
    </footer>
    
    <script type="module">
        const output = document.getElementById('output');
        const securityCheck = document.getElementById('security-check');
        
        /**
         * Check if Web Crypto API is available (secure context required)
         */
        function checkSecureContext() {
            const isSecure = window.isSecureContext;
            const protocol = window.location.protocol;
            const hostname = window.location.hostname;
            const hasSubtle = !!(window.crypto && window.crypto.subtle);
            
            if (!isSecure || !hasSubtle) {
                securityCheck.innerHTML = `
                    <div class="security-warning">
                        <h2>üîí SECURITY WARNING - Web Crypto API Unavailable</h2>
                        <p><strong>Current URL:</strong> <code>${window.location.href}</code></p>
                        <p style="margin-top: 12px;">Status:</p>
                        <ul>
                            <li>Protocol: <strong>${protocol}</strong> ${protocol === 'https:' ? '‚úÖ' : '‚ùå (Must be HTTPS)'}</li>
                            <li>Hostname: <strong>${hostname}</strong> ${hostname === 'localhost' || hostname === '127.0.0.1' ? '‚úÖ' : '‚ùå (Must be localhost or HTTPS)'}</li>
                            <li>Secure Context: <strong>${isSecure ? 'Yes ‚úÖ' : 'No ‚ùå'}</strong></li>
                            <li>crypto.subtle: <strong>${hasSubtle ? 'Available ‚úÖ' : 'Unavailable ‚ùå'}</strong></li>
                        </ul>
                        
                        <h2 style="margin-top: 24px;">‚úÖ SOLUTIONS:</h2>
                        
                        <div class="solution">
                            <strong>Option 1: Use Localhost (Recommended)</strong>
                            <p>Access via: <code>http://localhost:9000/quick-test.html</code></p>
                            <p>or: <code>http://127.0.0.1:9000/quick-test.html</code></p>
                        </div>
                        
                        <div class="solution">
                            <strong>Option 2: SSH Tunnel (If Remote Server)</strong>
                            <p>On your local machine, run:</p>
                            <p><code>ssh -L 9000:localhost:9000 ubuntu@${hostname}</code></p>
                            <p>Then access: <code>http://localhost:9000/quick-test.html</code></p>
                        </div>
                        
                        <div class="solution">
                            <strong>Option 3: Enable Insecure Origins (Chrome - Testing Only)</strong>
                            <p>1. Go to: <code>chrome://flags/#unsafely-treat-insecure-origin-as-secure</code></p>
                            <p>2. Add: <code>http://${hostname}:9000</code></p>
                            <p>3. Click "Relaunch"</p>
                        </div>
                        
                        <div class="solution">
                            <strong>Option 4: Deploy with HTTPS (Production)</strong>
                            <p>Use Let's Encrypt for free SSL certificate</p>
                            <p><code>sudo certbot --nginx</code></p>
                        </div>
                    </div>
                `;
                
                output.innerHTML = '<span class="error">‚ùå Cannot run tests - Web Crypto API unavailable\n\nWeb Crypto API requires a secure context (HTTPS or localhost).\nPlease use one of the solutions above.</span>';
                
                return false;
            } else {
                securityCheck.innerHTML = `
                    <div class="solution">
                        ‚úÖ Secure context detected - Web Crypto API available!
                        <span class="badge-success status-badge">READY</span>
                    </div>
                `;
                return true;
            }
        }
        
        /**
         * Main test suite
         */
        async function runTests() {
            let results = '';
            
            // Check security first
            if (!checkSecureContext()) {
                return;
            }
            
            try {
                results += 'üß™ Testing 4Word Crypto Modules\n';
                results += '‚ïê'.repeat(50) + '\n\n';
                
                // ============================================
                // Test 1: Web Crypto API
                // ============================================
                results += '1Ô∏è‚É£ Testing Web Crypto API...\n';
                const cryptoModule = await import('./js/crypto/webCrypto.js');
                const crypto = cryptoModule.default;
                results += '   ‚úÖ Module imported\n';
                
                // Basic encryption
                const testMessage = 'Hello 4Word - Secure Messaging Test!';
                const testPassword = 'TestPassword123!';
                
                const encrypted = await crypto.encrypt(testMessage, testPassword);
                results += '   ‚úÖ Encryption works\n';
                results += `   Algorithm: ${encrypted.algorithm}\n`;
                results += `   Iterations: ${encrypted.iterations.toLocaleString()}\n`;
                results += `   Ciphertext length: ${encrypted.encrypted.length} chars\n`;
                
                const decrypted = await crypto.decrypt(encrypted, testPassword);
                results += '   ‚úÖ Decryption works\n';
                
                if (decrypted === testMessage) {
                    results += '   ‚úÖ Encryption/Decryption verified!\n';
                } else {
                    throw new Error('Decryption mismatch - data integrity failed');
                }
                
                // Double encryption (2DE)
                results += '\n2Ô∏è‚É£ Testing Double Encryption (2DE)...\n';
                const secretMessage = 'Ultra Secret 2DE Message';
                const pass1 = 'FirstLayer123!';
                const pass2 = 'SecondLayer456!';
                
                const doubled = await crypto.doubleEncrypt(secretMessage, pass1, pass2);
                results += '   ‚úÖ 2DE encrypted\n';
                results += `   Layers: ${doubled.layers}\n`;
                results += `   Algorithm: ${doubled.algorithm}\n`;
                
                const undoubled = await crypto.doubleDecrypt(doubled, pass1, pass2);
                results += '   ‚úÖ 2DE decrypted\n';
                
                if (undoubled === secretMessage) {
                    results += '   ‚úÖ 2DE verified!\n';
                } else {
                    throw new Error('2DE decryption mismatch');
                }
                
                // Password generation
                results += '\n3Ô∏è‚É£ Testing Secure Password Generation...\n';
                const generatedPass = crypto.generateSecurePassword(32);
                results += `   ‚úÖ Generated: ${generatedPass}\n`;
                results += `   Length: ${generatedPass.length} characters\n`;
                
                // Verify password has variety
                const hasUpper = /[A-Z]/.test(generatedPass);
                const hasLower = /[a-z]/.test(generatedPass);
                const hasNumber = /[0-9]/.test(generatedPass);
                const hasSpecial = /[^A-Za-z0-9]/.test(generatedPass);
                
                results += `   Contains: ${hasUpper ? '‚úÖ' : '‚ùå'} Uppercase, ${hasLower ? '‚úÖ' : '‚ùå'} Lowercase, ${hasNumber ? '‚úÖ' : '‚ùå'} Numbers, ${hasSpecial ? '‚úÖ' : '‚ùå'} Special\n`;
                
                // Hash function
                results += '\n4Ô∏è‚É£ Testing SHA-256 Hash...\n';
                const testData = 'Test data for hashing';
                const hash1 = await crypto.hash(testData);
                const hash2 = await crypto.hash(testData);
                const hash3 = await crypto.hash('Different data');
                
                results += `   ‚úÖ Hash generated: ${hash1.substring(0, 24)}...\n`;
                results += `   ‚úÖ Deterministic: ${hash1 === hash2 ? 'Yes' : 'No'}\n`;
                results += `   ‚úÖ Different inputs produce different hashes: ${hash1 !== hash3 ? 'Yes' : 'No'}\n`;
                
                // ============================================
                // Test 2: Steganography
                // ============================================
                results += '\n5Ô∏è‚É£ Testing Steganography Module...\n';
                const stegoModule = await import('./js/crypto/steganography.js');
                const stego = stegoModule.default;
                results += '   ‚úÖ Steganography module loaded\n';
                results += '   Available methods:\n';
                results += '     - embedMessage(imageFile, message, password)\n';
                results += '     - extractMessage(imageFile, password)\n';
                results += '     - getImageCapacity(imageFile)\n';
                results += '   ‚ö†Ô∏è  Full testing requires image file upload\n';
                results += '   üí° Use main app to test stego features\n';
                
                // ============================================
                // Test 3: IndexedDB Storage
                // ============================================
                results += '\n6Ô∏è‚É£ Testing IndexedDB Storage...\n';
                const storageModule = await import('./js/storage/indexedDB.js');
                const storage = storageModule.default;
                
                await storage.init();
                results += '   ‚úÖ Storage initialized\n';
                
                const stats = await storage.getStats();
                results += `   ‚úÖ Database: ${stats.dbName} v${stats.version}\n`;
                results += `   ‚úÖ Current messages: ${stats.messageCount}\n`;
                
                // Save test message
                const masterPassword = 'MasterTestPass' + Date.now();
                const testMsg = {
                    type: 'test',
                    content: 'Test message from quick-test suite',
                    timestamp: Date.now()
                };
                
                const msgId = await storage.saveMessage(testMsg, masterPassword);
                results += `   ‚úÖ Message saved (ID: ${msgId})\n`;
                
                // Retrieve messages
                const messages = await storage.getMessages(masterPassword, 10);
                results += `   ‚úÖ Retrieved ${messages.length} message(s)\n`;
                
                if (messages.length > 0) {
                    results += `   ‚úÖ Latest message content verified\n`;
                }
                
                // Clean up
                await storage.deleteMessage(msgId);
                results += '   ‚úÖ Test message deleted (cleanup complete)\n';
                
                // ============================================
                // Test 4: Validation
                // ============================================
                results += '\n7Ô∏è‚É£ Testing Input Validation...\n';
                const validationModule = await import('./js/utils/validation.js');
                const { Validator } = validationModule;
                
                // Ethereum address validation
                const validAddr = '0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb0'; // 40 hex chars
                const invalidAddr = '0xinvalid';
                const shortAddr = '0x123';
                
                const validCheck = Validator.isValidAddress(validAddr);
                const invalidCheck = Validator.isValidAddress(invalidAddr);
                const shortCheck = Validator.isValidAddress(shortAddr);
                
                results += `   ‚úÖ Valid address accepted: ${validCheck ? 'Yes' : 'No'} ${validCheck ? '‚úÖ' : '‚ùå'}\n`;
                results += `   ‚úÖ Invalid address rejected: ${!invalidCheck ? 'Yes' : 'No'} ${!invalidCheck ? '‚úÖ' : '‚ùå'}\n`;
                results += `   ‚úÖ Short address rejected: ${!shortCheck ? 'Yes' : 'No'} ${!shortCheck ? '‚úÖ' : '‚ùå'}\n`;
                
                // Password strength validation
                const passwords = [
                    { pass: 'weak', expected: 'weak' },
                    { pass: 'Better123', expected: 'medium' },
                    { pass: 'Strong123!@#', expected: 'strong' }
                ];
                
                results += '   Password strength checks:\n';
                passwords.forEach(({ pass, expected }) => {
                    const result = Validator.validatePasswordStrength(pass);
                    const match = result.strength === expected;
                    results += `     "${pass}": ${result.strength.toUpperCase()} ${match ? '‚úÖ' : '‚ö†Ô∏è'}\n`;
                });
                
                // XSS sanitization
                const xssAttempt = '<script>alert("xss")</script>';
                const sanitized = Validator.sanitizeString(xssAttempt);
                const isSafe = !sanitized.includes('<script>');
                
                results += `   ‚úÖ XSS sanitization: ${isSafe ? 'Working' : 'Failed'} ${isSafe ? '‚úÖ' : '‚ùå'}\n`;
                results += `     Input:  ${xssAttempt}\n`;
                results += `     Output: ${sanitized}\n`;
                
                // File validation
                results += '   ‚úÖ File validators available:\n';
                results += '     - validateFileSize(file, maxMB)\n';
                results += '     - validateImageFile(file)\n';
                results += '     - sanitizeFilename(filename)\n';
                
                // Filename sanitization test
                const unsafeName = '../../../etc/passwd!@#$%.txt';
                const safeName = Validator.sanitizeFilename(unsafeName);
                results += `   ‚úÖ Filename sanitization:\n`;
                results += `     Unsafe: ${unsafeName}\n`;
                results += `     Safe:   ${safeName}\n`;
                
                // ============================================
                // Summary
                // ============================================
                results += '\n' + '‚ïê'.repeat(50) + '\n';
                results += 'üéâ ALL TESTS PASSED!\n';
                results += '‚ïê'.repeat(50) + '\n\n';
                
                results += '‚úÖ Your 4Word crypto system is fully functional!\n\n';
                
                results += 'Security Status:\n';
                results += `  Protocol:       ${window.location.protocol}\n`;
                results += `  Hostname:       ${window.location.hostname}\n`;
                results += `  Secure Context: ${window.isSecureContext ? 'Yes ‚úÖ' : 'No ‚ùå'}\n`;
                results += `  Web Crypto API: Available ‚úÖ\n\n`;
                
                results += 'Next Steps:\n';
                results += '  1. Test the main app: /index.html\n';
                results += '  2. Try steganography features\n';
                results += '  3. Deploy with HTTPS for production\n';
                results += '  4. Run security audit before public launch\n';
                
                output.innerHTML = `<span class="success">${results}</span>`;
                
            } catch (error) {
                results += `\n\n‚ùå TEST FAILED\n`;
                results += '‚ïê'.repeat(50) + '\n';
                results += `Error: ${error.message}\n\n`;
                
                if (error.stack) {
                    results += `Stack Trace:\n${error.stack}\n`;
                }
                
                output.innerHTML = `<span class="error">${results}</span>`;
                console.error('Test suite error:', error);
            }
        }
        
        // Run tests on page load
        runTests();
    </script>
</body>
</html>
